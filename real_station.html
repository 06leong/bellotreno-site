<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BelloTreno-Station</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500;700&family=Roboto:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* 车站看板特定样式 */
        .station-header {
            text-align: center;
            margin: 40px auto 20px;
            max-width: 100%;
            padding: 0 20px;
        }

        .station-name {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--md-sys-color-primary);
            margin: 0 auto 10px;
            display: block;
            width: 100%;
        }

        /* 车站看板特定样式 - 已统一使用全局 .search-mode-toggle 样式 */

        .board-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 16px;
        }

        .board-table {
            width: 100%;
            background: var(--bg-primary);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] .board-table {
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--md-sys-color-primary);
            color: white;
        }

        th {
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.95rem;
        }

        td {
            padding: 14px 12px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            color: var(--text-primary);
        }

        [data-theme="dark"] td {
            border-bottom-color: rgba(255, 255, 255, 0.05);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        tbody tr {
            cursor: pointer;
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] tbody tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .time-col {
            font-family: 'Roboto Mono', monospace;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .train-col {
            font-weight: 600;
            min-width: 80px;
        }

        .destination-col,
        .origin-col {
            min-width: 100px;
        }

        .status-col {
            font-weight: 500;
            min-width: 90px;
        }

        .platform-col {
            font-family: 'Roboto Mono', monospace;
            font-weight: 700;
            font-size: 1.1rem;
            min-width: 60px;
        }

        /* 站台呼吸灯效果 - 当火车在站时 */
        .platform-pulse {
            display: inline-block;
            animation: platformPulse 1.5s ease-in-out infinite;
            font-weight: 700;
            background: linear-gradient(135deg, var(--md-sys-color-primary) 0%, rgba(35, 57, 117, 0.2) 100%);
            padding: 2px 6px;
            border-radius: 4px;
            color: white !important;
            box-shadow: 0 0 10px rgba(35, 57, 117, 0.5);
        }

        [data-theme="dark"] .platform-pulse {
            background: linear-gradient(135deg, #a2e6fb 0%, rgba(162, 230, 251, 0.2) 100%);
            color: #0d131e !important;
            box-shadow: 0 0 15px rgba(162, 230, 251, 0.6);
        }

        @keyframes platformPulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.85;
                transform: scale(1.08);
            }
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-grey);
        }

        .loading .material-symbols-outlined {
            font-size: 48px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .error-message {
            text-align: center;
            padding: 40px 20px;
            color: var(--train-red);
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: var(--md-sys-color-primary);
            text-decoration: none;
            font-weight: 500;
            margin: 20px 0;
            transition: opacity 0.2s;
        }

        .back-link:hover {
            opacity: 0.7;
        }

        .scroll-hint {
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-grey);
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 8px;
            display: none;
        }

        [data-theme="dark"] .scroll-hint {
            background: rgba(255, 255, 255, 0.05);
        }

        .scroll-hint .material-symbols-outlined {
            font-size: 16px;
            vertical-align: middle;
        }

        /* 响应式 - 添加横向滚动支持 */
        .board-table {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            /* iOS 平滑滚动 */
        }

        table {
            min-width: 650px;
            /* 桌面端确保表格有最小宽度 */
        }

        /* 平板端（481px - 768px）*/
        @media (max-width: 768px) and (min-width: 481px) {
            .station-name {
                font-size: 1.8rem;
                word-break: break-word;
                padding: 0 10px;
            }

            .board-type-switch {
                max-width: 300px;
            }

            .board-type-btn {
                font-size: 0.9rem;
                padding: 8px 16px;
            }

            .scroll-hint {
                display: block;
            }

            /* 平板端显示滚动提示 */

            table {
                font-size: 0.85rem;
                min-width: 600px;
                /* 平板端需要横向滚动 */
            }

            th,
            td {
                padding: 10px 8px;
                white-space: nowrap;
                /* 平板端保持不换行 */
            }

            .time-col,
            .platform-col {
                font-size: 0.95rem;
            }
        }

        /* 手机端 - 紧凑模式 + 横向滚动 */
        @media (max-width: 480px) {
            .station-name {
                font-size: 1.5rem;
                padding: 0 8px;
            }

            .scroll-hint {
                display: block !important;
                /* 显示滚动提示 */
                font-size: 0.75rem;
                padding: 6px;
                margin-bottom: 8px;
            }

            table {
                font-size: 0.75rem;
                min-width: 440px;
                /* 紧凑布局，但允许横向滚动查看长内容 */
                width: auto;
                /* 自动宽度 */
                table-layout: fixed;
                /* 固定表格布局，确保列宽一致 */
            }

            th,
            td {
                padding: 8px 6px;
                white-space: normal;
                /* 允许换行 */
                word-wrap: break-word;
                vertical-align: middle;
                /* 居中对齐，视觉效果更好 */
                height: auto;
                min-height: 36px;
                /* 最小行高，确保一致性 */
            }

            tbody tr {
                border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            }

            [data-theme="dark"] tbody tr {
                border-bottom-color: rgba(255, 255, 255, 0.08);
            }

            /* 时间列 - 不换行，紧凑 */
            .time-col {
                font-size: 0.8rem;
                white-space: nowrap;
                min-width: 45px;
                max-width: 45px;
                padding-left: 4px !important;
                padding-right: 4px !important;
            }

            /* 车次列 - 允许换行，两行显示（如 REG\n3069） */
            .train-col {
                font-size: 0.72rem;
                line-height: 1.25;
                min-width: 56px;
                max-width: 56px;
                word-break: break-all;
                /* 强制在空格处断行 */
                padding-left: 4px !important;
                padding-right: 4px !important;
            }

            /* 目的地/始发站列 - 允许换行 */
            .destination-col,
            .origin-col {
                font-size: 0.72rem;
                line-height: 1.25;
                min-width: 85px;
                max-width: 85px;
                padding-left: 5px !important;
                padding-right: 5px !important;
            }

            /* 状态列 - 允许换行 */
            .status-col {
                font-size: 0.68rem;
                line-height: 1.25;
                min-width: 68px;
                max-width: 68px;
                padding-left: 4px !important;
                padding-right: 4px !important;
            }

            /* 站台列 - 允许换行，适应长站台名（如 4 TRONCO 1 Tronco） */
            .platform-col {
                font-size: 0.72rem;
                line-height: 1.25;
                white-space: normal;
                /* 允许换行 */
                min-width: 72px;
                max-width: 72px;
                word-wrap: break-word;
                padding-left: 4px !important;
                padding-right: 4px !important;
            }

            /* 表头字体调整 */
            th {
                font-size: 0.7rem;
                line-height: 1.2;
                padding: 6px 6px;
                font-weight: 600;
            }

            /* 确保表格容器可以滚动 */
            .board-table {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
</head>

<body>

    <!-- 导航栏 -->
    <nav class="navbar">
        <a href="index.html" data-i18n="nav_home" class="ripple">首页</a>
        <a href="infomobilita.html" data-i18n="nav_infomobilita" class="ripple">出行信息</a>
        <a href="about.html" data-i18n="nav_about" class="ripple">关于</a>
        <div class="lang-switch" onclick="toggleLangMenu()">
            <span class="material-symbols-outlined">language</span>
            <span id="currentLang">Chinese</span>
            <div class="dropdown-menu" id="langMenu">
                <div class="dropdown-item ripple" onclick="changeLang('zh'); event.stopPropagation();">Chinese</div>
                <div class="dropdown-item ripple" onclick="changeLang('en'); event.stopPropagation();">English</div>
                <div class="dropdown-item ripple" onclick="changeLang('it'); event.stopPropagation();">Italiano</div>
            </div>
        </div>
        <div class="theme-switch" onclick="toggleThemeMenu()">
            <span class="material-symbols-outlined">contrast</span>
            <span id="currentTheme" data-i18n="theme_auto">跟随系统</span>
            <div class="dropdown-menu" id="themeMenu">
                <div class="dropdown-item ripple" onclick="changeTheme('auto'); event.stopPropagation();"
                    data-i18n="theme_auto">跟随系统</div>
                <div class="dropdown-item ripple" onclick="changeTheme('light'); event.stopPropagation();"
                    data-i18n="theme_light">浅色模式</div>
                <div class="dropdown-item ripple" onclick="changeTheme('dark'); event.stopPropagation();"
                    data-i18n="theme_dark">深色模式</div>
            </div>
        </div>
    </nav>

    <!-- 回到顶部按钮 -->
    <div class="back-to-top ripple" onclick="scrollToTop()">
        <span class="material-symbols-outlined">arrow_upward</span>
    </div>

    <div class="container">
        <div class="station-header">
            <h1 class="station-name" id="stationName">--</h1>
            <div class="search-mode-toggle">
                <button class="mode-button mode-left active ripple" id="btnPartenze"
                    onclick="switchBoardType('partenze')">
                    <span class="material-symbols-outlined">train</span>
                    <span data-i18n="departures">离站</span>
                </button>
                <button class="mode-button mode-right ripple" id="btnArrivi" onclick="switchBoardType('arrivi')">
                    <span class="material-symbols-outlined">train</span>
                    <span data-i18n="arrivals">到站</span>
                </button>
            </div>
        </div>

        <div class="board-container">
            <div class="scroll-hint">
                <span class="material-symbols-outlined">swipe</span>
                <span data-i18n="scroll_hint">左右滑动查看完整信息</span>
            </div>

            <div id="loadingIndicator" class="loading">
                <span class="material-symbols-outlined">refresh</span>
                <p data-i18n="loading">加载中...</p>
            </div>

            <div id="errorMessage" class="error-message" style="display: none;">
                <span class="material-symbols-outlined" style="font-size: 48px;">error</span>
                <p data-i18n="load_error">加载失败，请稍后重试</p>
            </div>

            <div id="boardContent" style="display: none;"></div>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <span data-i18n="footer"> 本站数据仅供参考，如有问题请关注车站大屏获取最新信息。 | &copy; 2026 BelloTreno</span>
            <div class="visitor-stats">
                <span id="visitorCount"></span>
            </div>
        </div>
    </footer>

    <script src="js/config.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/common.js"></script>
    <script src="station.js"></script>
    <script>
        // 语言和主题现在由 common.js 管理
        let currentStationId = '';
        let currentStationName = '';
        let currentBoardType = 'partenze';

        // 当语言改变时刷新看板
        window.onLanguageChanged = function () {
            if (currentStationId) {
                loadStationBoard();
            }
        };

        // 模拟重定向函数 - 移除导致死循环的 shim，让 common.js 直接处理
        // goToTrainDetails 保持不变
        function goToTrainDetails(trainNumber) {
            if (!trainNumber) return;
            // 去除空格并跳转到 index.html
            const cleanTrainNumber = trainNumber.trim();
            window.location.href = `index.html?train=${encodeURIComponent(cleanTrainNumber)}`;
        }

        // 回到顶部功能
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 显示/隐藏回到顶部按钮
        window.addEventListener('scroll', () => {
            const backToTop = document.querySelector('.back-to-top');
            if (window.scrollY > 300) {
                backToTop.classList.add('show');
            } else {
                backToTop.classList.remove('show');
            }
        });

        // 切换看板类型
        function switchBoardType(type) {
            currentBoardType = type;

            // 更新按钮状态 - 统一使用 .mode-button 类名
            document.getElementById('btnPartenze').classList.toggle('active', type === 'partenze');
            document.getElementById('btnArrivi').classList.toggle('active', type === 'arrivi');

            // 强制重新加载最新数据
            loadStationBoard();
        }

        // 加载车站看板（每次调用都获取最新数据）
        async function loadStationBoard() {
            const loadingEl = document.getElementById('loadingIndicator');
            const errorEl = document.getElementById('errorMessage');
            const contentEl = document.getElementById('boardContent');

            // 显示加载动画
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            contentEl.style.display = 'none';

            try {
                // 获取最新的车站看板数据（API 会使用当前意大利时间）
                const data = await fetchStationBoard(currentStationId, currentBoardType);

                if (!data || data.length === 0) {
                    errorEl.style.display = 'block';
                    errorEl.querySelector('p').textContent = (typeof translations !== 'undefined' && translations[window.currentLang]) ? translations[window.currentLang].load_error : 'No data';
                    loadingEl.style.display = 'none';
                    return;
                }

                // 渲染最新数据
                renderStationBoard(data);
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
            } catch (error) {
                console.error('Failed to load station board:', error);
                errorEl.style.display = 'block';
                loadingEl.style.display = 'none';
            }
        }

        // 渲染车站看板
        function renderStationBoard(trains) {
            const contentEl = document.getElementById('boardContent');
            const t = translations[window.currentLang];

            let tableHtml = '<div class="board-table"><table>';

            if (currentBoardType === 'partenze') {
                // 离站看板
                tableHtml += `
                <thead>
                    <tr>
                        <th>${t.scheduled_time}</th>
                        <th>${t.train}</th>
                        <th>${t.destination}</th>
                        <th>${t.status}</th>
                        <th>${t.platform}</th>
                    </tr>
                </thead>
                <tbody>
            `;

                trains.forEach(train => {
                    const formatted = formatDepartureData(train, window.currentLang);
                    // 获取原始车次号（不带 <br>）
                    const trainNumber = (train.compNumeroTreno || '').replace(/"/g, '&quot;');
                    tableHtml += `
                    <tr class="train-row" data-train-number="${trainNumber}">
                        <td class="time-col">${formatted.scheduledTime}</td>
                        <td class="train-col">${formatted.trainNumber}</td>
                        <td class="destination-col">${formatted.destination}</td>
                        <td class="status-col" style="color:${formatted.statusColor}">${formatted.status}</td>
                        <td class="platform-col">${formatted.platformHtml}</td>
                    </tr>
                `;
                });
            } else {
                // 到站看板 - 车次列在始发站之前
                tableHtml += `
                <thead>
                    <tr>
                        <th>${t.scheduled_time}</th>
                        <th>${t.train}</th>
                        <th>${t.origin}</th>
                        <th>${t.actual_time}</th>
                        <th>${t.status}</th>
                        <th>${t.platform}</th>
                    </tr>
                </thead>
                <tbody>
            `;

                trains.forEach(train => {
                    const formatted = formatArrivalData(train, window.currentLang);
                    // 获取原始车次号（不带 <br>）
                    const trainNumber = (train.compNumeroTreno || '').replace(/"/g, '&quot;');
                    tableHtml += `
                    <tr class="train-row" data-train-number="${trainNumber}">
                        <td class="time-col">${formatted.scheduledTime}</td>
                        <td class="train-col">${formatted.trainNumber}</td>
                        <td class="origin-col">${formatted.origin}</td>
                        <td class="time-col">${formatted.actualTime}</td>
                        <td class="status-col" style="color:${formatted.statusColor}">${formatted.status}</td>
                        <td class="platform-col">${formatted.platformHtml}</td>
                    </tr>
                `;
                });
            }

            tableHtml += '</tbody></table></div>';
            contentEl.innerHTML = tableHtml;

            // 为所有列车行添加点击事件（事件委托）
            const trainRows = contentEl.querySelectorAll('.train-row');
            trainRows.forEach(row => {
                row.addEventListener('click', function () {
                    const trainNumber = this.getAttribute('data-train-number');
                    if (trainNumber) {
                        goToTrainDetails(trainNumber);
                    }
                });
            });
        }

        // 初始化页面
        function initPage() {
            // initLanguage 和 initTheme 现由 common.js 在 DOMContentLoaded 时自动处理

            // 从 URL 参数获取车站信息
            const params = new URLSearchParams(window.location.search);
            currentStationId = params.get('id') || '';
            currentStationName = decodeURIComponent(params.get('name') || '');
            currentBoardType = params.get('type') || 'partenze';

            if (!currentStationId) {
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('loadingIndicator').style.display = 'none';
                return;
            }

            document.getElementById('stationName').textContent = currentStationName;

            // 更新按钮状态
            document.getElementById('btnPartenze').classList.toggle('active', currentBoardType === 'partenze');
            document.getElementById('btnArrivi').classList.toggle('active', currentBoardType === 'arrivi');

            // 加载数据
            loadStationBoard();
        }

        // 页面加载完成后初始化
        initPage();
    </script>

</body>

</html>