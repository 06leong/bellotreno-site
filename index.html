<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BelloTreno - 意大利火车实时情况</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500;700&family=Roboto:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script type="module">
        import 'https://esm.run/@material/web/all.js';
    </script>
    <style>
        /* 页面特定样式可以保留在这里 */
    </style>
</head>
<body>

<!-- 导航栏 -->
<nav class="navbar">
    <a href="#" onclick="goHome(); return false;" data-i18n="nav_home" class="ripple">首页</a>
    <a href="about.html" data-i18n="nav_about" class="ripple">关于</a>
    <div class="lang-switch" onclick="toggleLangMenu()">
        <span class="material-symbols-outlined">language</span>
        <span id="currentLang">简体中文</span>
        <div class="dropdown-menu" id="langMenu">
            <div class="dropdown-item ripple" onclick="changeLang('zh'); event.stopPropagation();">简体中文</div>
            <div class="dropdown-item ripple" onclick="changeLang('en'); event.stopPropagation();">English</div>
            <div class="dropdown-item ripple" onclick="changeLang('it'); event.stopPropagation();">Italiano</div>
        </div>
    </div>
    <div class="theme-switch" onclick="toggleThemeMenu()">
        <span class="material-symbols-outlined">contrast</span>
        <span id="currentTheme" data-i18n="theme_auto">跟随系统</span>
        <div class="dropdown-menu" id="themeMenu">
            <div class="dropdown-item ripple" onclick="changeTheme('auto'); event.stopPropagation();" data-i18n="theme_auto">跟随系统</div>
            <div class="dropdown-item ripple" onclick="changeTheme('light'); event.stopPropagation();" data-i18n="theme_light">浅色模式</div>
            <div class="dropdown-item ripple" onclick="changeTheme('dark'); event.stopPropagation();" data-i18n="theme_dark">深色模式</div>
        </div>
    </div>
</nav>

<!-- 回到顶部按钮 -->
<div class="back-to-top ripple" onclick="scrollToTop()">
    <span class="material-symbols-outlined">arrow_upward</span>
</div>

<div class="container">
    <div class="search-section">
        <a href="#" class="logo-link" onclick="goHome(); return false;">
            <h1 style="color: var(--md-sys-color-primary); font-size: 2.5rem; margin-bottom: 10px;">BelloTreno</h1>
        </a>
        <md-filled-text-field id="trainSearch" label="" type="text">
            <md-icon slot="leading-icon">train</md-icon>
        </md-filled-text-field>
        
        <!-- 最近搜索记录 -->
        <div id="recentSearchesContainer" class="recent-searches-container" style="display: none;">
            <div class="recent-searches-label">
                <span class="material-symbols-outlined">history</span>
                <span data-i18n="recent_searches">最近搜索</span>
            </div>
            <div id="recentSearchesChips" class="recent-searches-chips"></div>
        </div>
    </div>

    <!-- 歧义消除面板 -->
    <div id="disambiguation">
        <h3 style="margin-top:0; color: var(--md-sys-color-primary)" data-i18n="disambiguation_title">检测到多个班次，请选择：</h3>
        <div id="choicesList"></div>
    </div>

    <!-- 结果展示区 -->
    <div id="results">
        <div id="trainCard" class="train-header"></div>
        <div class="timeline-container">
            <div id="timelineBody"></div>
        </div>
    </div>
</div>

<footer>
    <span data-i18n="footer"> 本站数据仅供参考，如有问题请关注车站大屏获取最新信息。 | &copy; 2026 BelloTreno</span>
</footer>

<script src="station.js"></script>
<script>
    // API 基础路径（全局变量，供 station.js 使用）
    window.API_BASE = "https://api.bellotreno.org/?url=https://www.viaggiatreno.it/infomobilita/resteasy/viaggiatreno";
    const API_BASE = window.API_BASE; // 本地引用

    const CLIENT_MAP = { 1: "Trenitalia", 2: "Trenitalia", 4: "Trenitalia", 18: "Trenitalia TPER", 30: "Ferrovie del Sud Est", 63: "Trenord", 64: "ÖBB" };
    
    const CLIENT_LINK_MAP = {
        "Trenitalia": "https://www.trenitalia.com",
        "Trenitalia TPER": "https://www.trenitaliatper.it",
        "Ferrovie del Sud Est": "https://www.trenitalia.com",
        "Trenord": "https://www.trenord.it",
        "ÖBB": "https://www.oebb.at"
    };
    
    const CAT_MAP = {
        "REG": "Regionale", "RV": "Regionale Veloce", "MET": "Metropolitan", "FR": "Frecciarossa", 
        "IC": "Intercity", "ICN": "Intercity Notte", "EC": "Eurocity", "FB": "Frecciabianca", 
        "FA": "Frecciargento", "EN": "EuroNight", "RE": "Regionale"
    };

    // 服务类型图片映射 (运营商代码 + 类型代码)
    const CAT_IMAGE_MAP = {
        // Trenitalia (1, 2, 4)
        "1-IC": "pic/IC.png",
        "2-IC": "pic/IC.png",
        "4-IC": "pic/IC.png",
        "1-ICN": "pic/ICN.png",
        "2-ICN": "pic/ICN.png",
        "4-ICN": "pic/ICN.png",
        "1-REG": "pic/RV.png",
        "2-REG": "pic/RV.png",
        "4-REG": "pic/RV.png",
        "1-RV": "pic/RV.png",
        "2-RV": "pic/RV.png",
        "4-RV": "pic/RV.png",
        "1-MET": "pic/RV.png",
        "2-MET": "pic/RV.png",
        "4-MET": "pic/RV.png",
        "1-RE": "pic/RV.png",
        "2-RE": "pic/RV.png",
        "4-RE": "pic/RV.png",
        "1-FR": "pic/FR.png",
        "2-FR": "pic/FR.png",
        "4-FR": "pic/FR.png",
        "1-FA": "pic/FA.png",
        "2-FA": "pic/FA.png",
        "4-FA": "pic/FA.png",
        "1-FB": "pic/FB.png",
        "2-FB": "pic/FB.png",
        "4-FB": "pic/FB.png",
        "1-EC": "pic/EC.png",
        "2-EC": "pic/EC.png",
        "4-EC": "pic/EC.png",
        "1-EN": "pic/EN.png",
        "2-EN": "pic/EN.png",
        "4-EN": "pic/EN.png",
        // Trenitalia TPER (18)
        "18-REG": "pic/regn.png",
        "18-RV": "pic/regn.png",
        "18-RE": "pic/regn.png",
        // Ferrovie del Sud Est (30)
        "30-REG": "pic/regn.png",
        "30-RV": "pic/regn.png",
        "30-RE": "pic/regn.png",
        // Trenord (63)
        "63-REG": "pic/regn.png",
        "63-RV": "pic/regn.png",
        "63-RE": "pic/regn.png",
        // ÖBB (64)
        "64-EC": "pic/RJ.png",
        "64-EN": "pic/NJ.png"
    };

    // 多语言翻译
    const translations = {
        zh: {
            nav_home: "首页",
            nav_about: "关于",
            theme_auto: "跟随系统",
            theme_light: "浅色模式",
            theme_dark: "深色模式",
            search_placeholder: "输入车次（例如 FR9633, IC630,REG2025 或纯数字）",
            disclaimer: "目前不支持 Italo 和 SNCF 列车。",
            recent_searches: "最近搜索",
            disambiguation_title: "检测到多个班次，请选择：",
            depart_date: "始发日期",
            origin_station: "始发站ID",
            duration: "总时长约",
            direction: "方向",
            train_num: "车次",
            last_position: "最后位置",
            arrival: "到达",
            departure: "出发",
            expected: "预计",
            stop_duration: "停靠时长",
            platform: "站台",
            direction: "方向",
            executive_head: "Executive 在车头",
            executive_tail: "Executive 在车尾",
            in_head: "在车头",
            in_tail: "在车尾",
            minutes: "分钟",
            hours: "小时",
            not_departed: "未出发",
            on_time: "准点",
            early_by: "提前",
            late_by: "晚点",
            footer: " 本站数据仅供参考，如有问题请关注车站大屏获取最新信息。 | © 2026 BelloTreno"
        },
        en: {
            nav_home: "Home",
            nav_about: "About",
            theme_auto: "Follow System",
            theme_light: "Light Mode",
            theme_dark: "Dark Mode",
            search_placeholder: "Enter train number (e.g. FR9633, IC630, REG2025 or numbers)",
            disclaimer: "Italo and SNCF trains are not currently supported.",
            recent_searches: "Recent Searches",
            disambiguation_title: "Multiple trains detected, please select:",
            depart_date: "Departure Date",
            origin_station: "Origin Station ID",
            duration: "Total Duration",
            direction: "Direction",
            train_num: "Train No.",
            last_position: "Last Position",
            arrival: "Arrival",
            departure: "Departure",
            expected: "Expected",
            stop_duration: "Stop Duration",
            platform: "Platform",
            direction: "Direction",
            executive_head: "Executive at the head",
            executive_tail: "Executive at the tail",
            in_head: "at the head",
            in_tail: "at the tail",
            minutes: "min",
            hours: "h",
            not_departed: "Not Departed",
            on_time: "On Time",
            early_by: "Early by",
            late_by: "Delayed by",
            footer: "This information is for reference only. Please check station displays for official information. | © 2026 BelloTreno"
        },
        it: {
            nav_home: "Home",
            nav_about: "Informazioni",
            theme_auto: "Segui Sistema",
            theme_light: "Modalità Chiara",
            theme_dark: "Modalità Scura",
            search_placeholder: "Inserisci numero treno (es. FR9633, IC630, REG2025 o numeri)",
            disclaimer: "Treni Italo e SNCF non sono attualmente supportati.",
            recent_searches: "Ricerche Recenti",
            disambiguation_title: "Rilevati più treni, seleziona:",
            depart_date: "Data di partenza",
            origin_station: "ID Stazione Origine",
            duration: "Durata Totale",
            direction: "Direzione",
            train_num: "Treno",
            last_position: "Ultima Posizione",
            arrival: "Arrivo",
            departure: "Partenza",
            expected: "Previsto",
            stop_duration: "Durata Fermata",
            platform: "Binario",
            direction: "Direzione",
            executive_head: "Executive in testa",
            executive_tail: "Executive in coda",
            in_head: "in testa",
            in_tail: "in coda",
            minutes: "min",
            hours: "h",
            not_departed: "Non Partito",
            on_time: "In Orario",
            early_by: "In Anticipo di",
            late_by: "In Ritardo di",
            footer: "Queste informazioni sono solo di riferimento. Controllare i display delle stazioni per informazioni ufficiali. | © 2026 BelloTreno"
        }
    };

    let currentLang = 'zh';
    let currentTheme = 'auto';
    let currentTrainData = null;
    let currentTriple = null;
    let disambiguationData = null; // 存储歧义数据以便语言切换时重新渲染

    // 初始化语言
    function initLanguage() {
        const savedLang = localStorage.getItem('language');
        if (savedLang) {
            currentLang = savedLang;
        } else {
            const browserLang = navigator.language.toLowerCase();
            if (browserLang.startsWith('zh')) {
                currentLang = 'zh';
            } else if (browserLang.startsWith('it')) {
                currentLang = 'it';
            } else {
                currentLang = 'en';
            }
        }
        updateLanguage();
    }

    // 更新语言
    function updateLanguage() {
        const langNames = { zh: '简体中文', en: 'English', it: 'Italiano' };
        document.getElementById('currentLang').textContent = langNames[currentLang];
        document.documentElement.lang = currentLang;
        
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (translations[currentLang][key]) {
                el.textContent = translations[currentLang][key];
            }
        });
        
        // 更新搜索框placeholder
        document.getElementById('trainSearch').label = translations[currentLang].search_placeholder;
        
        // 如果有歧义面板显示，重新渲染
        if (disambiguationData) {
            renderDisambiguation();
        }
        
        // 如果有车次信息显示，重新渲染
        if (currentTrainData) {
            render(currentTrainData);
        }
    }

    // 切换语言
    function changeLang(lang) {
        currentLang = lang;
        localStorage.setItem('language', lang);
        updateLanguage();
        document.getElementById('langMenu').classList.remove('show');
    }

    // 初始化主题
    function initTheme() {
        const savedTheme = localStorage.getItem('theme') || 'auto';
        currentTheme = savedTheme;
        applyTheme();
        updateThemeDisplay();
    }

    // 应用主题
    function applyTheme() {
        if (currentTheme === 'auto') {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
        } else {
            document.documentElement.setAttribute('data-theme', currentTheme);
        }
    }

    // 更新主题显示
    function updateThemeDisplay() {
        const themeKey = `theme_${currentTheme}`;
        document.getElementById('currentTheme').textContent = translations[currentLang][themeKey];
        document.getElementById('currentTheme').setAttribute('data-i18n', themeKey);
    }

    // 切换主题
    function changeTheme(theme) {
        currentTheme = theme;
        localStorage.setItem('theme', theme);
        applyTheme();
        updateThemeDisplay();
        document.getElementById('themeMenu').classList.remove('show');
    }

    // 切换下拉菜单
    function toggleLangMenu() {
        const menu = document.getElementById('langMenu');
        menu.classList.toggle('show');
        document.getElementById('themeMenu').classList.remove('show');
    }

    function toggleThemeMenu() {
        const menu = document.getElementById('themeMenu');
        menu.classList.toggle('show');
        document.getElementById('langMenu').classList.remove('show');
    }

    // 点击外部关闭下拉菜单
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.lang-switch') && !e.target.closest('.theme-switch')) {
            document.getElementById('langMenu').classList.remove('show');
            document.getElementById('themeMenu').classList.remove('show');
        }
    });

    // 监听系统主题变化
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        if (currentTheme === 'auto') {
            applyTheme();
        }
    });

    // 回到顶部功能
    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 显示/隐藏回到顶部按钮
    window.addEventListener('scroll', () => {
        const backToTop = document.querySelector('.back-to-top');
        if (window.scrollY > 300) {
            backToTop.classList.add('show');
        } else {
            backToTop.classList.remove('show');
        }
    });

    // 返回首页
    function goHome() {
        window.location.href = '/';
    }

    // 格式化时长
    function formatDuration(duration) {
        if (!duration) return 'N/A';
        const parts = duration.split(':');
        if (parts.length === 2) {
            const hours = parseInt(parts[0]);
            const mins = parseInt(parts[1]);
            if (currentLang === 'zh') {
                return `${hours}小时${mins}分钟`;
            } else if (currentLang === 'it') {
                return `${hours}h:${mins}min`;
            } else {
                return `${hours}h:${mins}min`;
            }
        }
        return duration;
    }

    // 翻译状态
    function translateStatus(text) {
        if (!text) return "";
        
        if (currentLang === 'zh') {
            return text
                .replace(/non partito/gi, "未出发")
                .replace(/con un anticipo di/g, "提前")
                .replace(/con un ritardo di/g, "晚点")
                .replace(/in orario/g, "准点")
                .replace(/(\d+)\s*min\./g, "$1分钟");
        } else if (currentLang === 'en') {
            return text
                .replace(/non partito/gi, "Not Departed")
                .replace(/con un anticipo di/g, "Early by")
                .replace(/con un ritardo di/g, "Delayed by")
                .replace(/in orario/g, "On Time")
                .replace(/(\d+)\s*min\./g, "$1 min");
        }
        
        // 意大利语保持原文
        return text;
    }

    // ========== 最近搜索记录功能 ==========
    
    // 保存最近搜索记录
    function saveRecentSearch(trainNumber, trainInfo) {
        try {
            // 从localStorage获取现有记录
            let recentSearches = JSON.parse(localStorage.getItem('recentTrains') || '[]');
            
            // 创建搜索记录对象（包含车次号和始发站，方便显示）
            const searchItem = {
                number: trainNumber,
                origin: trainInfo.origine || '',
                destination: trainInfo.destinazione || '',
                timestamp: Date.now()
            };
            
            // 去重：如果已存在相同车次号，先移除
            recentSearches = recentSearches.filter(item => item.number !== trainNumber);
            
            // 将新记录添加到数组首位
            recentSearches.unshift(searchItem);
            
            // 限制最多保留5条记录
            if (recentSearches.length > 5) {
                recentSearches = recentSearches.slice(0, 5);
            }
            
            // 保存到localStorage
            localStorage.setItem('recentTrains', JSON.stringify(recentSearches));
            
            // 重新渲染chips
            renderRecentSearches();
        } catch (err) {
            console.error('Failed to save recent search:', err);
        }
    }
    
    // 加载并渲染最近搜索记录
    function loadRecentSearches() {
        try {
            const recentSearches = JSON.parse(localStorage.getItem('recentTrains') || '[]');
            if (recentSearches.length > 0) {
                renderRecentSearches();
            }
        } catch (err) {
            console.error('Failed to load recent searches:', err);
        }
    }
    
    // 渲染最近搜索chips
    function renderRecentSearches() {
        try {
            const recentSearches = JSON.parse(localStorage.getItem('recentTrains') || '[]');
            const container = document.getElementById('recentSearchesContainer');
            const chipsContainer = document.getElementById('recentSearchesChips');
            
            if (recentSearches.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            chipsContainer.innerHTML = '';
            
            recentSearches.forEach(item => {
                const chip = document.createElement('div');
                chip.className = 'assist-chip';
                
                // 显示格式：车次号 (始发站 → 终点站)
                const label = `${item.number}`;
                
                chip.innerHTML = `
                    <span class="chip-label">${label}</span>
                    <span class="chip-remove" onclick="removeRecentSearch('${item.number}', event)">
                        <span class="material-symbols-outlined">close</span>
                    </span>
                `;
                
                // 点击chip主体时触发搜索（但不包括删除按钮）
                chip.querySelector('.chip-label').addEventListener('click', () => {
                    document.getElementById('trainSearch').value = item.number;
                    startSearch(item.number.replace(/\D/g, ''));
                });
                
                chipsContainer.appendChild(chip);
            });
        } catch (err) {
            console.error('Failed to render recent searches:', err);
        }
    }
    
    // 删除单个最近搜索记录
    function removeRecentSearch(trainNumber, event) {
        if (event) {
            event.stopPropagation(); // 阻止事件冒泡，避免触发搜索
        }
        
        try {
            let recentSearches = JSON.parse(localStorage.getItem('recentTrains') || '[]');
            recentSearches = recentSearches.filter(item => item.number !== trainNumber);
            localStorage.setItem('recentTrains', JSON.stringify(recentSearches));
            renderRecentSearches();
        } catch (err) {
            console.error('Failed to remove recent search:', err);
        }
    }
    
    // ========== 页面初始化 ==========
    initLanguage();
    initTheme();
    loadRecentSearches(); // 加载最近搜索记录

    document.getElementById('trainSearch').addEventListener('keypress', async (e) => {
        if (e.key === 'Enter') {
            const num = e.target.value.replace(/\D/g, '');
            if (num) startSearch(num);
        }
    });

    async function startSearch(num) {
        document.getElementById('results').style.display = 'none';
        document.getElementById('disambiguation').style.display = 'none';

        try {
            const autoRes = await fetch(`${API_BASE}/cercaNumeroTrenoTrenoAutocomplete/${num}`);
            const autoText = await autoRes.text();
            if (!autoText.trim()) {
                const msg = currentLang === 'zh' ? "未找到该车次" :
                           currentLang === 'it' ? "Treno non trovato" :
                           "Train not found";
                return alert(msg);
            }

            const lines = autoText.trim().split('\n');
            if (lines.length > 1) {
                showDisambiguation(lines);
            } else {
                fetchDetails(lines[0].split('|')[1]);
            }
        } catch (err) {
            const msg = currentLang === 'zh' ? "搜索失败" :
                       currentLang === 'it' ? "Ricerca fallita" :
                       "Search failed";
            alert(msg);
        }
    }

    function showDisambiguation(lines) {
        disambiguationData = lines; // 保存数据
        renderDisambiguation();
    }

    function renderDisambiguation() {
        if (!disambiguationData) return;
        
        const list = document.getElementById('choicesList');
        const panel = document.getElementById('disambiguation');
        list.innerHTML = '';
        
        disambiguationData.forEach(line => {
            const [label, triple] = line.split('|');
            const [tNum, sID, ts] = triple.split('-');
            // 将 Unix 毫秒戳转为当地日期
            const dateObj = new Date(parseInt(ts));
            const dateStr = dateObj.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: '2-digit' });
            
            const div = document.createElement('div');
            div.className = 'choice-item ripple';
            div.innerHTML = `
                <div style="font-size:1.1rem; font-weight:bold; color:var(--md-sys-color-primary)">${label}</div>
                <div style="font-size:0.9rem; color:var(--text-grey); margin-top:4px">
                    <span class="material-symbols-outlined" style="font-size:14px; vertical-align:middle">calendar_month</span> ${translations[currentLang].depart_date}: ${dateStr} 
                    | <span class="material-symbols-outlined" style="font-size:14px; vertical-align:middle">location_on</span> ${translations[currentLang].origin_station}: ${sID}
                </div>
            `;
            div.onclick = () => {
                panel.style.display = 'none';
                disambiguationData = null; // 清除数据
                fetchDetails(triple);
            };
            list.appendChild(div);
        });
        panel.style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function fetchDetails(triple) {
        currentTriple = triple;
        const [tNum, originID, ts] = triple.split('-');
        try {
            const res = await fetch(`${API_BASE}/andamentoTreno/${originID}/${tNum}/${ts}`);
            if (res.status === 204) {
                const msg = currentLang === 'zh' ? "该班次暂无实时数据（可能已过期或尚未生成）" :
                           currentLang === 'it' ? "Nessun dato in tempo reale per questo treno (potrebbe essere scaduto o non ancora generato)" :
                           "No real-time data for this train (may be expired or not yet generated)";
                return alert(msg);
            }
            const data = await res.json();
            currentTrainData = data;
            render(data);
            
            // 保存到最近搜索记录
            const trainNumber = `${data.compCategoria || ''} ${data.numeroTreno || tNum}`.trim();
            saveRecentSearch(trainNumber, data);
        } catch (err) {
            const msg = currentLang === 'zh' ? "详情加载失败" :
                       currentLang === 'it' ? "Impossibile caricare i dettagli" :
                       "Failed to load details";
            alert(msg);
        }
    }

    // 刷新车次信息
    async function refreshTrainData() {
        if (!currentTriple) return;
        const refreshBtn = document.querySelector('.refresh-btn');
        if (refreshBtn) {
            refreshBtn.style.opacity = '0.5';
            refreshBtn.style.pointerEvents = 'none';
        }
        await fetchDetails(currentTriple);
        if (refreshBtn) {
            setTimeout(() => {
                refreshBtn.style.opacity = '1';
                refreshBtn.style.pointerEvents = 'auto';
            }, 1000);
        }
    }

    function formatT(ms) {
        if (!ms) return null;
        return new Date(ms).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', timeZone: 'Europe/Rome' });
    }

    function renderTimeHtml(label, schedMs, realMs, delayMin) {
        const sched = formatT(schedMs);
        const real = formatT(realMs);
        if (!real) return `<div class="time-item"><span class="time-label">${label} | ${translations[currentLang].expected}:</span> <b>${sched || '--:--'}</b></div>`;
        const isDiff = sched !== real;
        const colorClass = (delayMin > 0) ? "late" : "early";
        return `
            <div class="time-item">
                <span class="time-label">${label} |</span> 
                ${isDiff ? `<span class="time-val-sched">${sched}</span>` : ''}
                <span class="time-val-real ${colorClass}">${real}</span>
            </div>
        `;
    }

    function render(data) {
        document.getElementById('results').style.display = 'block';
        const card = document.getElementById('trainCard');
        const timeline = document.getElementById('timelineBody');

        // --- 核心逻辑：箭系列类型识别 ---
        let catCode = (data.categoria || "").trim();
        // 如果 categoria 为空，尝试从 compNumeroTreno (如 " FR 9505") 提取前缀
        if (!catCode && data.compNumeroTreno) {
            const match = data.compNumeroTreno.match(/([A-Z]+)/);
            if (match) catCode = match[1];
        }

        const operator = CLIENT_MAP[data.codiceCliente] || "Other";
        const category = CAT_MAP[catCode] || data.categoriaDescrizione || catCode || "Treno";
        
        // 获取运营商链接
        const operatorLink = CLIENT_LINK_MAP[operator] || "#";
        const operatorHTML = operatorLink !== "#" ? `<a href="${operatorLink}" target="_blank" style="color: inherit; text-decoration: none;">${operator}</a>` : operator;
        
        // 获取服务类型图片
        const imageKey = `${data.codiceCliente}-${catCode}`;
        const categoryImage = CAT_IMAGE_MAP[imageKey];
        const categoryHTML = categoryImage ? `<img src="${categoryImage}" alt="${category}" style="height: 1.3rem; vertical-align: middle; margin-left: 8px;">` : category;

        const displayOrigin = data.origineEstera || data.origine;
        const displayDest = data.destinazioneEstera || data.destinazione;
        const delayMsg = translateStatus(data.compRitardoAndamento[0]);
        const isEarly = delayMsg.includes(translations[currentLang].early_by) || 
                       delayMsg.includes(translations[currentLang].on_time) ||
                       delayMsg.toLowerCase().includes("anticipo") ||
                       delayMsg.toLowerCase().includes("orario") ||
                       delayMsg.toLowerCase().includes("early");

        const formattedDuration = formatDuration(data.compDurata);

        card.innerHTML = `
            <div class="refresh-btn ripple" onclick="refreshTrainData()" title="${currentLang === 'zh' ? '刷新' : currentLang === 'it' ? 'Aggiorna' : 'Refresh'}">
                <span class="material-symbols-outlined">refresh</span>
            </div>
            <div class="op-cat-row" style="display: flex; align-items: center;">${operatorHTML} · ${categoryHTML}</div>
            <div class="train-info-wrapper">
                <div>
                    <div class="train-route">${displayOrigin} ➜ ${displayDest}</div>
                    <div class="train-meta">
                        ${translations[currentLang].train_num}: <b>${data.compNumeroTreno}</b> | ${translations[currentLang].duration}: <b>${formattedDuration}</b>
                    </div>
                </div>
                <div class="train-status-section">
                    <div class="train-delay ${isEarly ? '' : 'late'}">${delayMsg}</div>
                    <div class="train-last-position">${translations[currentLang].last_position}: ${data.stazioneUltimoRilevamento} (${data.compOraUltimoRilevamento || '--:--'})</div>
                </div>
            </div>
        `;

        // 渲染实时公告 (subTitle)
        if (data.subTitle && data.subTitle.trim()) {
            card.innerHTML += `
                <div class="alert-box">
                    <span class="material-symbols-outlined" style="font-size:20px">campaign</span>
                    <span>${data.subTitle}</span>
                </div>
            `;
        }

        // Timeline 进度算法 - Segment 分段式
        timeline.innerHTML = '';
        
        // 计算锚点索引：最后一个有实际到达或出发记录的站点
        let lastReachedIdx = -1;
        if (!data.nonPartito) {
            data.fermate.forEach((f, i) => { 
                if (f.arrivoReale !== null || f.partenzaReale !== null) lastReachedIdx = i; 
            });
        }

        const totalStations = data.fermate.length;

        data.fermate.forEach((f, i) => {
            const isLast = i === totalStations - 1;
            const isFirst = i === 0;
            
            // 状态机逻辑 - 确定圆点状态
            let dotClass = 'dot-future';  // 默认：未到达
            if (lastReachedIdx >= 0) {
                if (i < lastReachedIdx) {
                    dotClass = 'dot-passed';   // 已通过的站点（小绿点）
                } else if (i === lastReachedIdx) {
                    dotClass = 'dot-current';  // 当前站点（带动画的大绿点）
                }
            }
            
            // 状态机逻辑 - 确定轨道段状态
            // 规则：索引 i 与 i+1 之间的轨道，当 i < lastReachedIdx 时变绿
            const isSegmentActive = (i < lastReachedIdx);
            const segmentClass = isSegmentActive ? 'segment-line segment-active' : 'segment-line';
            
            const stationItemClasses = ['station-item', dotClass];

            const pPlat = f.binarioProgrammatoPartenzaDescrizione || f.binarioProgrammatoArrivoDescrizione;
            const ePlat = f.binarioEffettivoPartenzaDescrizione || f.binarioEffettivoArrivoDescrizione;
            let platHTML = (ePlat && pPlat && ePlat !== pPlat) 
                ? `<span class="plat-old">${pPlat}</span><span class="plat-new">${ePlat}</span>`
                : `<span class="plat-normal">${pPlat || "--"}</span>`;

            const stayMinutes = (f.partenza_teorica && f.arrivo_teorico) ? Math.round((f.partenza_teorica - f.arrivo_teorico) / 60000) : null;
            const stayTime = stayMinutes ? `${stayMinutes} ${translations[currentLang].minutes}` : "N/A";
            
            // 获取方向信息（如果有的话）- 显示在站名旁边
            let directionBadge = '';
            if (f.orientamento) {
                let directionText = '';
                if (f.orientamento === 'A') {
                    directionText = `Executive ${translations[currentLang].in_tail}`;
                } else if (f.orientamento === 'B') {
                    directionText = `Executive ${translations[currentLang].in_head}`;
                } else {
                    directionText = f.orientamento;
                }
                directionBadge = `<span class="direction-badge">${directionText}</span>`;
            }

            // 生成站点HTML - 包含圆点、轨道段和卡片
            const stationHTML = `
                <div class="${stationItemClasses.join(' ')}">
                    <div class="station-dot-wrapper">
                        <div class="station-dot"></div>
                        <div class="${segmentClass}"></div>
                    </div>
                    <div class="station-card">
                        <div class="station-name">
                            <span class="station-link" data-station-id="${f.id}" data-station-name="${f.stazione.replace(/"/g, '&quot;')}">${f.stazione}</span>
                            ${directionBadge}
                        </div>
                        <div class="info-row">
                            ${!isFirst ? renderTimeHtml(translations[currentLang].arrival, (f.arrivo_teorico || f.programmata), f.arrivoReale, f.ritardoArrivo) : ''}
                            ${!isLast ? renderTimeHtml(translations[currentLang].departure, (f.partenza_teorica || f.programmata), f.partenzaReale, f.ritardoPartenza) : ''}
                            ${(!isFirst && !isLast) ? `<div class="time-item"><span class="time-label">${translations[currentLang].stop_duration}:</span> <b>${stayTime}</b></div>` : ''}
                        </div>
                        <div class="info-row secondary">
                            <div class="time-item"><span class="time-label">${translations[currentLang].platform}:</span> ${platHTML}</div>
                            <div class="time-item" style="color: var(--text-grey);"><span class="time-label">Progressivo:</span> <b>${f.progressivo}</b></div>
                        </div>
                    </div>
                </div>
            `;
            timeline.innerHTML += stationHTML;
        });
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // 为站名链接添加事件监听器（使用事件代理）
    // 注意：直接绑定到 document，因为 timeline 内容是动态生成的
    document.addEventListener('click', function(e) {
        // 检查点击的是否是站名链接
        const stationLink = e.target.closest('.station-link');
        if (stationLink) {
            const stationId = stationLink.getAttribute('data-station-id');
            const stationName = stationLink.getAttribute('data-station-name');
            if (stationId && stationName) {
                goToStationBoard(stationId, stationName);
            }
        }
    });
</script>
</body>
</html>