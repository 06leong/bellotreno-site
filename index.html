<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BelloTreno - 意大利火车实时情况</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500;700&family=Roboto:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet">
    <script type="module">
        import 'https://esm.run/@material/web/all.js';
    </script>
    <style>
        :root {
            --md-sys-color-primary: #006a6a;
            --md-sys-color-surface: #f4fbfa;
            --train-green: #2e7d32;
            --train-grey: #cfd8dc;
            --train-red: #d32f2f;
            --text-grey: #90a4ae;
            --alert-bg: #fffde7;
            --alert-text: #f57f17;
            --text-primary: #233975;
            --bg-primary: #f4fbfa;
        }

        [data-theme="dark"] {
            --text-primary: #a2e6fb;
            --bg-primary: #0d131e;
            --md-sys-color-surface: #0d131e;
            --md-sys-color-primary: #4db6ac;
            --train-grey: #455a64;
            --text-grey: #78909c;
            --alert-bg: #1a2332;
            --alert-text: #ffd54f;
        }

        body { font-family: 'Roboto', 'Noto Sans SC', sans-serif; margin: 0; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; }
        * { box-sizing: border-box; }
        
        /* 导航栏 */
        .navbar { position: fixed; top: 0; left: 0; right: 0; background: var(--bg-primary); border-bottom: 1px solid rgba(0,0,0,0.1); padding: 12px 20px; display: flex; justify-content: flex-end; align-items: center; gap: 15px; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        [data-theme="dark"] .navbar { border-bottom-color: rgba(255,255,255,0.1); }
        .navbar a { color: var(--text-primary); text-decoration: none; font-weight: 500; font-size: 0.95rem; transition: opacity 0.2s; padding: 6px 12px; }
        .navbar a:hover { opacity: 0.7; }
        .theme-switch, .lang-switch { cursor: pointer; display: flex; align-items: center; gap: 5px; padding: 6px 12px; border-radius: 20px; background: rgba(0,0,0,0.05); transition: background 0.2s; position: relative; }
        [data-theme="dark"] .theme-switch, [data-theme="dark"] .lang-switch { background: rgba(255,255,255,0.1); }
        .theme-switch:hover, .lang-switch:hover { background: rgba(0,0,0,0.1); }
        [data-theme="dark"] .theme-switch:hover, [data-theme="dark"] .lang-switch:hover { background: rgba(255,255,255,0.15); }
        .theme-switch .material-symbols-outlined, .lang-switch .material-symbols-outlined { font-size: 20px; color: var(--text-primary); }
        
        /* 下拉菜单 */
        .dropdown-menu { display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; background: var(--bg-primary); border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 150px; overflow: hidden; }
        [data-theme="dark"] .dropdown-menu { border-color: rgba(255,255,255,0.2); }
        .dropdown-menu.show { display: block; }
        .dropdown-item { padding: 12px 16px; cursor: pointer; color: var(--text-primary); transition: background 0.2s; font-size: 0.9rem; }
        .dropdown-item:hover { background: rgba(0,0,0,0.05); }
        [data-theme="dark"] .dropdown-item:hover { background: rgba(255,255,255,0.1); }
        .dropdown-item.active { background: rgba(0,106,106,0.1); font-weight: 600; }
        
        .container { width: 100%; max-width: 950px; margin: 0 auto; padding: 80px 16px 16px; box-sizing: border-box; flex: 1; overflow-x: hidden; }
        
        /* 搜索区 */
        .search-section { margin: 40px 0 20px; text-align: center; }
        .logo-link { color: var(--md-sys-color-primary); text-decoration: none; }
        .logo-link:hover { opacity: 0.8; }
        md-filled-text-field { width: 100%; max-width: 100%; --md-filled-text-field-container-shape: 28px; }
        [data-theme="dark"] md-filled-text-field { --md-filled-text-field-input-text-color: #000000; --md-filled-text-field-label-text-color: #000000; }
        .disclaimer { margin-top: 12px; font-size: 0.75rem; color: var(--text-grey); display: flex; align-items: center; justify-content: center; gap: 6px; flex-wrap: wrap; }

        /* 歧义选择面板 */
        #disambiguation { display: none; background: var(--bg-primary); border-radius: 24px; padding: 24px; margin: 0 auto 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); border: 2px solid var(--md-sys-color-primary); max-width: 950px; }
        .choice-item { cursor: pointer; padding: 16px; border-bottom: 1px solid rgba(0,0,0,0.1); transition: background 0.2s; border-radius: 12px; margin-bottom: 8px; }
        [data-theme="dark"] .choice-item { border-bottom-color: rgba(255,255,255,0.1); }
        .choice-item:last-child { border-bottom: none; }
        .choice-item:hover { background: rgba(0,106,106,0.1); }

        /* 头部卡片 */
        .train-header { background: var(--bg-primary); padding: 24px; border-radius: 24px; margin: 0 auto 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.1); position: relative; max-width: 950px; overflow-x: hidden; }
        [data-theme="dark"] .train-header { border-color: rgba(255,255,255,0.2); }
        .op-cat-row { font-weight: 700; color: var(--md-sys-color-primary); margin-bottom: 8px; font-size: 1.1rem; }
        .op-cat-row a { transition: opacity 0.2s; }
        .op-cat-row a:hover { opacity: 0.7; }
        .op-cat-row img { display: inline-block; vertical-align: middle; height: 1.3rem; margin-left: 4px; }
        .refresh-btn { position: absolute; top: 20px; right: 20px; cursor: pointer; padding: 8px; border-radius: 50%; background: rgba(0,0,0,0.05); transition: all 0.3s; }
        [data-theme="dark"] .refresh-btn { background: rgba(255,255,255,0.1); }
        .refresh-btn:hover { background: rgba(0,106,106,0.2); transform: rotate(90deg); }
        .refresh-btn .material-symbols-outlined { font-size: 24px; color: var(--text-primary); }
        
        .train-info-wrapper { display: flex; justify-content: space-between; align-items: flex-end; gap: 20px; flex-wrap: wrap; }
        .train-route { font-size: 2rem; font-weight: 800; color: var(--text-primary); letter-spacing: -0.5px; word-wrap: break-word; }
        .train-meta { font-size: 1rem; color: var(--text-grey); margin-top: 8px; word-wrap: break-word; }
        .train-status-section { text-align: right; }
        .train-delay { color: var(--train-green); font-size: 1.6rem; font-weight: 800; }
        .train-delay.late { color: var(--train-red); }
        .train-last-position { font-size: 0.95rem; color: var(--text-grey); margin-top: 4px; }
        
        /* 公告框 */
        .alert-box { background: var(--alert-bg); color: var(--alert-text); padding: 14px 18px; border-radius: 14px; margin-top: 16px; font-size: 0.95rem; display: flex; align-items: flex-start; gap: 10px; border: 1px solid rgba(255,245,157,0.5); line-height: 1.5; }

        /* Timeline 布局 - Material Design 3 Segment 风格 */
        .timeline-container { position: relative; margin: 20px auto 0; padding: 40px 20px; background: var(--bg-primary); border-radius: 24px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.1); max-width: 950px; overflow-x: hidden; }
        [data-theme="dark"] .timeline-container { border-color: rgba(255,255,255,0.2); }
        
        /* 站点项目 - 每个站点是一个Segment（圆点 + 下方轨道线 + 卡片） */
        .station-item { 
            position: relative; 
            display: flex;
            align-items: flex-start;
            gap: 20px;
        }
        
        /* 站点圆点和轨道容器 */
        .station-dot-wrapper {
            flex-shrink: 0;
            width: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            align-self: stretch; /* 让容器撑满整个高度 */
        }
        
        /* 站点圆点 - M3 标准样式 */
        .station-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--bg-primary);
            border: 4px solid var(--train-grey);
            flex-shrink: 0;
            z-index: 2;
            transition: all 0.3s ease;
            margin-top: 10px; /* 与站名对齐 */
        }
        
        /* 轨道线段 - 从圆点下方延伸到下一站圆点 */
        .segment-line {
            width: 5px;
            flex: 1; /* 填满剩余空间，自动延伸到下一站 */
            min-height: 20px;
            background: var(--train-grey);
            border-radius: 2px;
            margin-top: 2px; /* 与圆点微微间隔 */
        }
        
        /* 绿色轨道线段 - 已通过的路段 */
        .segment-line.segment-active {
            background: var(--train-green);
        }
        
        /* 最后一站不显示轨道线 */
        .station-item:last-child .segment-line {
            display: none;
        }
        
        /* 已通过的站点圆点 - 实心绿色小圆点 */
        .station-item.dot-passed .station-dot {
            width: 14px;
            height: 14px;
            border: none;
            background: var(--train-green);
        }
        
        /* 当前站点圆点 - 绿色且放大，带脉动动画 */
        .station-item.dot-current .station-dot {
            border-color: var(--train-green);
            background: var(--train-green);
            transform: scale(1.3);
            animation: pulse 2s ease-in-out infinite;
        }
        
        /* 脉动动画 */
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(46, 125, 50, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(46, 125, 50, 0);
            }
        }
        
        /* 未到达的站点圆点 - 灰色空心 */
        .station-item.dot-future .station-dot {
            border-color: var(--train-grey);
            background: var(--bg-primary);
        }

        .station-card { background: rgba(0,0,0,0.02); padding: 18px 24px; border-radius: 16px; border: 1px solid rgba(0,0,0,0.05); color: #1f1f1f; flex: 1; margin-bottom: 20px; }
        .station-item:last-child .station-card { margin-bottom: 0; }
        [data-theme="dark"] .station-card { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); color: #ffffff; }
        .station-name { font-weight: 700; font-size: 1.25rem; margin-bottom: 12px; color: var(--text-primary); display: flex; align-items: center; gap: 12px; flex-wrap: wrap; word-wrap: break-word; }
        .direction-badge { display: inline-flex; align-items: center; padding: 4px 12px; background: rgba(128,128,128,0.2); border-radius: 8px; font-size: 0.85rem; font-weight: 500; color: inherit; white-space: nowrap; }
        [data-theme="dark"] .direction-badge { background: rgba(128,128,128,0.3); }
        .info-row { display: flex; gap: 35px; font-size: 0.95rem; margin-bottom: 8px; flex-wrap: wrap; }
        .info-row.secondary { border-top: 1px dashed var(--train-grey); padding-top: 12px; margin-top: 12px; color: var(--text-grey); }
        .time-label { color: inherit; }
        .time-item { color: inherit; }
        .time-val-sched { text-decoration: line-through red; color: var(--text-grey); margin-right: 8px; }
        .time-val-real.late { color: var(--train-red); font-weight: 700; }
        .time-val-real.early { color: var(--train-green); font-weight: 700; }
        .plat-old { text-decoration: line-through red; color: var(--text-grey); margin-right: 8px; }
        .plat-new { color: var(--train-green); font-weight: 900; }
        .plat-normal { font-weight: 800; color: var(--text-primary); }

        /* 回到顶部按钮 */
        .back-to-top { position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; background: #233975; color: white; border-radius: 50%; display: none; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.3s; z-index: 999; }
        .back-to-top:hover { background: #1a2a5a; transform: translateY(-5px); }
        .back-to-top.show { display: flex; }
        .back-to-top .material-symbols-outlined { font-size: 28px; }

        footer { margin-top: auto; padding: 20px 16px; text-align: center; font-size: 0.85rem; color: var(--text-grey); width: 100%; }
        footer span { display: block; max-width: 950px; margin: 0 auto; word-wrap: break-word; line-height: 1.6; }
        #results { display: none; }
        
        /* 响应式设计 - 移动端优化 */
        @media (max-width: 768px) {
            .navbar { padding: 10px 12px; gap: 8px; flex-wrap: wrap; }
            .navbar a { font-size: 0.85rem; padding: 4px 8px; }
            .theme-switch, .lang-switch { padding: 4px 8px; font-size: 0.85rem; }
            .theme-switch .material-symbols-outlined, .lang-switch .material-symbols-outlined { font-size: 18px; }
            
            .container { padding: 70px 12px 12px; }
            .search-section { margin: 20px 0 15px; }
            .search-section h1 { font-size: 2rem !important; }
            .disclaimer { font-size: 0.7rem; padding: 0 8px; }
            
            #disambiguation { padding: 16px; margin: 0 8px 16px; }
            .choice-item { padding: 12px; }
            
            .train-header { padding: 16px; margin: 0 8px 16px; }
            .refresh-btn { top: 12px; right: 12px; padding: 6px; }
            .refresh-btn .material-symbols-outlined { font-size: 20px; }
            .op-cat-row { font-size: 0.95rem; }
            .train-info-wrapper { flex-direction: column; align-items: flex-start; gap: 12px; }
            .train-route { font-size: 1.4rem; }
            .train-meta { font-size: 0.85rem; }
            .train-status-section { text-align: left; width: 100%; }
            .train-delay { font-size: 1.2rem; }
            .train-last-position { font-size: 0.8rem; }
            
            .timeline-container { padding: 30px 15px; margin: 16px 8px 0; }
            
            /* 移动端站点和轨道调整 */
            .station-item { gap: 12px; }
            
            .station-dot-wrapper { width: 30px; }
            
            .station-dot {
                width: 14px;
                height: 14px;
                border: 3px solid var(--train-grey);
                margin-top: 8px;
            }
            
            .segment-line { width: 4px; }
            
            .station-item.dot-passed .station-dot {
                width: 10px;
                height: 10px;
            }
            
            .station-item.dot-current .station-dot {
                transform: scale(1.2);
            }
            .station-card { padding: 14px 16px; }
            .station-name { font-size: 1.1rem; gap: 8px; }
            .direction-badge { font-size: 0.75rem; padding: 3px 8px; }
            .info-row { gap: 20px; font-size: 0.85rem; }
            .info-row.secondary { font-size: 0.8rem; }
            
            .back-to-top { width: 45px; height: 45px; bottom: 20px; right: 20px; }
            .back-to-top .material-symbols-outlined { font-size: 24px; }
            
            footer { font-size: 0.7rem; padding: 16px 10px; }
            footer span { font-size: 0.7rem; padding: 0 5px; }
        }
        
        /* 超小屏幕优化 */
        @media (max-width: 480px) {
            .navbar { gap: 6px; }
            .navbar a { font-size: 0.8rem; padding: 4px 6px; white-space: nowrap; }
            .theme-switch span:not(.material-symbols-outlined), 
            .lang-switch span:not(.material-symbols-outlined) { display: none; }
            
            .search-section h1 { font-size: 1.8rem !important; }
            .train-route { font-size: 1.2rem; }
            .train-meta { font-size: 0.8rem; }
            .info-row { gap: 15px; font-size: 0.8rem; }
            
            footer { font-size: 0.65rem; padding: 14px 8px; }
            footer span { font-size: 0.65rem; padding: 0 4px; }
        }
    </style>
</head>
<body>

<!-- 导航栏 -->
<nav class="navbar">
    <a href="#" onclick="goHome(); return false;" data-i18n="nav_home">首页</a>
    <a href="about.html" data-i18n="nav_about">关于</a>
    <div class="lang-switch" onclick="toggleLangMenu()">
        <span class="material-symbols-outlined">language</span>
        <span id="currentLang">简体中文</span>
        <div class="dropdown-menu" id="langMenu">
            <div class="dropdown-item" onclick="changeLang('zh'); event.stopPropagation();">简体中文</div>
            <div class="dropdown-item" onclick="changeLang('en'); event.stopPropagation();">English</div>
            <div class="dropdown-item" onclick="changeLang('it'); event.stopPropagation();">Italiano</div>
        </div>
    </div>
    <div class="theme-switch" onclick="toggleThemeMenu()">
        <span class="material-symbols-outlined">contrast</span>
        <span id="currentTheme" data-i18n="theme_auto">跟随系统</span>
        <div class="dropdown-menu" id="themeMenu">
            <div class="dropdown-item" onclick="changeTheme('auto'); event.stopPropagation();" data-i18n="theme_auto">跟随系统</div>
            <div class="dropdown-item" onclick="changeTheme('light'); event.stopPropagation();" data-i18n="theme_light">浅色模式</div>
            <div class="dropdown-item" onclick="changeTheme('dark'); event.stopPropagation();" data-i18n="theme_dark">深色模式</div>
        </div>
    </div>
</nav>

<!-- 回到顶部按钮 -->
<div class="back-to-top" onclick="scrollToTop()">
    <span class="material-symbols-outlined">arrow_upward</span>
</div>

<div class="container">
    <div class="search-section">
        <a href="#" class="logo-link" onclick="goHome(); return false;">
            <h1 style="color: var(--md-sys-color-primary); font-size: 2.5rem; margin-bottom: 10px;">BelloTreno</h1>
        </a>
        <md-filled-text-field id="trainSearch" label="" type="text">
            <md-icon slot="leading-icon">train</md-icon>
        </md-filled-text-field>
        <div class="disclaimer">
            <span class="material-symbols-outlined" style="font-size: 18px;">warning</span>
            <span data-i18n="disclaimer">目前不支持 Italo 和 SNCF 列车。</span>
        </div>
    </div>

    <!-- 歧义消除面板 -->
    <div id="disambiguation">
        <h3 style="margin-top:0; color: var(--md-sys-color-primary)" data-i18n="disambiguation_title">检测到多个班次，请选择：</h3>
        <div id="choicesList"></div>
    </div>

    <!-- 结果展示区 -->
    <div id="results">
        <div id="trainCard" class="train-header"></div>
        <div class="timeline-container">
            <div id="timelineBody"></div>
        </div>
    </div>
</div>

<footer>
    <span data-i18n="footer">数据来源于ViaggiaTreno, 本站数据仅供参考，如有问题请关注车站大屏获取最新信息。 | &copy; 2026 BelloTreno</span>
</footer>

<script>
    const API_BASE = "https://api.bellotreno.org/?url=https://www.viaggiatreno.it/infomobilita/resteasy/viaggiatreno";

    const CLIENT_MAP = { 1: "Trenitalia", 2: "Trenitalia", 4: "Trenitalia", 18: "Trenitalia TPER", 30: "Ferrovie del Sud Est", 63: "Trenord", 64: "ÖBB" };
    
    const CLIENT_LINK_MAP = {
        "Trenitalia": "https://www.trenitalia.com",
        "Trenitalia TPER": "https://www.trenitaliatper.it",
        "Ferrovie del Sud Est": "https://www.trenitalia.com",
        "Trenord": "https://www.trenord.it",
        "ÖBB": "https://www.oebb.at"
    };
    
    const CAT_MAP = {
        "REG": "Regionale", "RV": "Regionale Veloce", "MET": "Metropolitan", "FR": "Frecciarossa", 
        "IC": "Intercity", "ICN": "Intercity Notte", "EC": "Eurocity", "FB": "Frecciabianca", 
        "FA": "Frecciargento", "EN": "EuroNight", "RE": "Regionale"
    };

    // 服务类型图片映射 (运营商代码 + 类型代码)
    const CAT_IMAGE_MAP = {
        // Trenitalia (1, 2, 4)
        "1-IC": "pic/IC.png",
        "2-IC": "pic/IC.png",
        "4-IC": "pic/IC.png",
        "1-ICN": "pic/ICN.png",
        "2-ICN": "pic/ICN.png",
        "4-ICN": "pic/ICN.png",
        "1-REG": "pic/RV.png",
        "2-REG": "pic/RV.png",
        "4-REG": "pic/RV.png",
        "1-RV": "pic/RV.png",
        "2-RV": "pic/RV.png",
        "4-RV": "pic/RV.png",
        "1-MET": "pic/RV.png",
        "2-MET": "pic/RV.png",
        "4-MET": "pic/RV.png",
        "1-RE": "pic/RV.png",
        "2-RE": "pic/RV.png",
        "4-RE": "pic/RV.png",
        "1-FR": "pic/FR.png",
        "2-FR": "pic/FR.png",
        "4-FR": "pic/FR.png",
        "1-FA": "pic/FA.png",
        "2-FA": "pic/FA.png",
        "4-FA": "pic/FA.png",
        "1-FB": "pic/FB.png",
        "2-FB": "pic/FB.png",
        "4-FB": "pic/FB.png",
        "1-EC": "pic/EC.png",
        "2-EC": "pic/EC.png",
        "4-EC": "pic/EC.png",
        "1-EN": "pic/EN.png",
        "2-EN": "pic/EN.png",
        "4-EN": "pic/EN.png",
        // Trenitalia TPER (18)
        "18-REG": "pic/regn.png",
        "18-RV": "pic/regn.png",
        "18-RE": "pic/regn.png",
        // Ferrovie del Sud Est (30)
        "30-REG": "pic/regn.png",
        "30-RV": "pic/regn.png",
        "30-RE": "pic/regn.png",
        // Trenord (63)
        "63-REG": "pic/regn.png",
        "63-RV": "pic/regn.png",
        "63-RE": "pic/regn.png",
        // ÖBB (64)
        "64-EC": "pic/RJ.png",
        "64-EN": "pic/NJ.png"
    };

    // 多语言翻译
    const translations = {
        zh: {
            nav_home: "首页",
            nav_about: "关于",
            theme_auto: "跟随系统",
            theme_light: "浅色模式",
            theme_dark: "深色模式",
            search_placeholder: "输入车次（例如 FR9633, IC630, EC144, R2025 或纯数字）",
            disclaimer: "目前不支持 Italo 和 SNCF 列车。",
            disambiguation_title: "检测到多个班次，请选择：",
            depart_date: "始发日期",
            origin_station: "始发站ID",
            duration: "总时长约",
            direction: "方向",
            train_num: "车次",
            last_position: "最后位置",
            arrival: "到达",
            departure: "出发",
            expected: "预计",
            stop_duration: "停靠时长",
            platform: "站台",
            direction: "方向",
            executive_head: "Executive 在车头",
            executive_tail: "Executive 在车尾",
            in_head: "在车头",
            in_tail: "在车尾",
            minutes: "分钟",
            hours: "小时",
            not_departed: "未出发",
            on_time: "准点",
            early_by: "提前",
            late_by: "晚点",
            footer: " 本站数据仅供参考，如有问题请关注车站大屏获取最新信息。 | © 2026 BelloTreno"
        },
        en: {
            nav_home: "Home",
            nav_about: "About",
            theme_auto: "Follow System",
            theme_light: "Light Mode",
            theme_dark: "Dark Mode",
            search_placeholder: "Enter train number (e.g. FR9633, IC630, EC144, R2025 or numbers)",
            disclaimer: "Italo and SNCF trains are not currently supported.",
            disambiguation_title: "Multiple trains detected, please select:",
            depart_date: "Departure Date",
            origin_station: "Origin Station ID",
            duration: "Total Duration",
            direction: "Direction",
            train_num: "Train No.",
            last_position: "Last Position",
            arrival: "Arrival",
            departure: "Departure",
            expected: "Expected",
            stop_duration: "Stop Duration",
            platform: "Platform",
            direction: "Direction",
            executive_head: "Executive at the head",
            executive_tail: "Executive at the tail",
            in_head: "at the head",
            in_tail: "at the tail",
            minutes: "min",
            hours: "h",
            not_departed: "Not Departed",
            on_time: "On Time",
            early_by: "Early by",
            late_by: "Delayed by",
            footer: "This information is for reference only. Please check station displays for official information. | © 2026 BelloTreno"
        },
        it: {
            nav_home: "Home",
            nav_about: "Informazioni",
            theme_auto: "Segui Sistema",
            theme_light: "Modalità Chiara",
            theme_dark: "Modalità Scura",
            search_placeholder: "Inserisci numero treno (es. FR9633, IC630, EC144, R2025 o numeri)",
            disclaimer: "Treni Italo e SNCF non sono attualmente supportati.",
            disambiguation_title: "Rilevati più treni, seleziona:",
            depart_date: "Data di partenza",
            origin_station: "ID Stazione Origine",
            duration: "Durata Totale",
            direction: "Direzione",
            train_num: "Treno",
            last_position: "Ultima Posizione",
            arrival: "Arrivo",
            departure: "Partenza",
            expected: "Previsto",
            stop_duration: "Durata Fermata",
            platform: "Binario",
            direction: "Direzione",
            executive_head: "Executive in testa",
            executive_tail: "Executive in coda",
            in_head: "in testa",
            in_tail: "in coda",
            minutes: "min",
            hours: "h",
            not_departed: "Non Partito",
            on_time: "In Orario",
            early_by: "In Anticipo di",
            late_by: "In Ritardo di",
            footer: "Queste informazioni sono solo di riferimento. Controllare i display delle stazioni per informazioni ufficiali. | © 2026 BelloTreno"
        }
    };

    let currentLang = 'zh';
    let currentTheme = 'auto';
    let currentTrainData = null;
    let currentTriple = null;
    let disambiguationData = null; // 存储歧义数据以便语言切换时重新渲染

    // 初始化语言
    function initLanguage() {
        const savedLang = localStorage.getItem('language');
        if (savedLang) {
            currentLang = savedLang;
        } else {
            const browserLang = navigator.language.toLowerCase();
            if (browserLang.startsWith('zh')) {
                currentLang = 'zh';
            } else if (browserLang.startsWith('it')) {
                currentLang = 'it';
            } else {
                currentLang = 'en';
            }
        }
        updateLanguage();
    }

    // 更新语言
    function updateLanguage() {
        const langNames = { zh: '简体中文', en: 'English', it: 'Italiano' };
        document.getElementById('currentLang').textContent = langNames[currentLang];
        document.documentElement.lang = currentLang;
        
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (translations[currentLang][key]) {
                el.textContent = translations[currentLang][key];
            }
        });
        
        // 更新搜索框placeholder
        document.getElementById('trainSearch').label = translations[currentLang].search_placeholder;
        
        // 如果有歧义面板显示，重新渲染
        if (disambiguationData) {
            renderDisambiguation();
        }
        
        // 如果有车次信息显示，重新渲染
        if (currentTrainData) {
            render(currentTrainData);
        }
    }

    // 切换语言
    function changeLang(lang) {
        currentLang = lang;
        localStorage.setItem('language', lang);
        updateLanguage();
        document.getElementById('langMenu').classList.remove('show');
    }

    // 初始化主题
    function initTheme() {
        const savedTheme = localStorage.getItem('theme') || 'auto';
        currentTheme = savedTheme;
        applyTheme();
        updateThemeDisplay();
    }

    // 应用主题
    function applyTheme() {
        if (currentTheme === 'auto') {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
        } else {
            document.documentElement.setAttribute('data-theme', currentTheme);
        }
    }

    // 更新主题显示
    function updateThemeDisplay() {
        const themeKey = `theme_${currentTheme}`;
        document.getElementById('currentTheme').textContent = translations[currentLang][themeKey];
        document.getElementById('currentTheme').setAttribute('data-i18n', themeKey);
    }

    // 切换主题
    function changeTheme(theme) {
        currentTheme = theme;
        localStorage.setItem('theme', theme);
        applyTheme();
        updateThemeDisplay();
        document.getElementById('themeMenu').classList.remove('show');
    }

    // 切换下拉菜单
    function toggleLangMenu() {
        const menu = document.getElementById('langMenu');
        menu.classList.toggle('show');
        document.getElementById('themeMenu').classList.remove('show');
    }

    function toggleThemeMenu() {
        const menu = document.getElementById('themeMenu');
        menu.classList.toggle('show');
        document.getElementById('langMenu').classList.remove('show');
    }

    // 点击外部关闭下拉菜单
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.lang-switch') && !e.target.closest('.theme-switch')) {
            document.getElementById('langMenu').classList.remove('show');
            document.getElementById('themeMenu').classList.remove('show');
        }
    });

    // 监听系统主题变化
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        if (currentTheme === 'auto') {
            applyTheme();
        }
    });

    // 回到顶部功能
    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 显示/隐藏回到顶部按钮
    window.addEventListener('scroll', () => {
        const backToTop = document.querySelector('.back-to-top');
        if (window.scrollY > 300) {
            backToTop.classList.add('show');
        } else {
            backToTop.classList.remove('show');
        }
    });

    // 返回首页
    function goHome() {
        window.location.href = '/';
    }

    // 格式化时长
    function formatDuration(duration) {
        if (!duration) return 'N/A';
        const parts = duration.split(':');
        if (parts.length === 2) {
            const hours = parseInt(parts[0]);
            const mins = parseInt(parts[1]);
            if (currentLang === 'zh') {
                return `${hours}小时${mins}分钟`;
            } else if (currentLang === 'it') {
                return `${hours}h:${mins}min`;
            } else {
                return `${hours}h:${mins}min`;
            }
        }
        return duration;
    }

    // 翻译状态
    function translateStatus(text) {
        if (!text) return "";
        
        if (currentLang === 'zh') {
            return text
                .replace(/non partito/gi, "未出发")
                .replace(/con un anticipo di/g, "提前")
                .replace(/con un ritardo di/g, "晚点")
                .replace(/in orario/g, "准点")
                .replace(/(\d+)\s*min\./g, "$1分钟");
        } else if (currentLang === 'en') {
            return text
                .replace(/non partito/gi, "Not Departed")
                .replace(/con un anticipo di/g, "Early by")
                .replace(/con un ritardo di/g, "Delayed by")
                .replace(/in orario/g, "On Time")
                .replace(/(\d+)\s*min\./g, "$1 min");
        }
        
        // 意大利语保持原文
        return text;
    }

    // 页面初始化
    initLanguage();
    initTheme();

    document.getElementById('trainSearch').addEventListener('keypress', async (e) => {
        if (e.key === 'Enter') {
            const num = e.target.value.replace(/\D/g, '');
            if (num) startSearch(num);
        }
    });

    async function startSearch(num) {
        document.getElementById('results').style.display = 'none';
        document.getElementById('disambiguation').style.display = 'none';

        try {
            const autoRes = await fetch(`${API_BASE}/cercaNumeroTrenoTrenoAutocomplete/${num}`);
            const autoText = await autoRes.text();
            if (!autoText.trim()) {
                const msg = currentLang === 'zh' ? "未找到该车次" :
                           currentLang === 'it' ? "Treno non trovato" :
                           "Train not found";
                return alert(msg);
            }

            const lines = autoText.trim().split('\n');
            if (lines.length > 1) {
                showDisambiguation(lines);
            } else {
                fetchDetails(lines[0].split('|')[1]);
            }
        } catch (err) {
            const msg = currentLang === 'zh' ? "搜索失败" :
                       currentLang === 'it' ? "Ricerca fallita" :
                       "Search failed";
            alert(msg);
        }
    }

    function showDisambiguation(lines) {
        disambiguationData = lines; // 保存数据
        renderDisambiguation();
    }

    function renderDisambiguation() {
        if (!disambiguationData) return;
        
        const list = document.getElementById('choicesList');
        const panel = document.getElementById('disambiguation');
        list.innerHTML = '';
        
        disambiguationData.forEach(line => {
            const [label, triple] = line.split('|');
            const [tNum, sID, ts] = triple.split('-');
            // 将 Unix 毫秒戳转为当地日期
            const dateObj = new Date(parseInt(ts));
            const dateStr = dateObj.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: '2-digit' });
            
            const div = document.createElement('div');
            div.className = 'choice-item';
            div.innerHTML = `
                <div style="font-size:1.1rem; font-weight:bold; color:var(--md-sys-color-primary)">${label}</div>
                <div style="font-size:0.9rem; color:var(--text-grey); margin-top:4px">
                    <span class="material-symbols-outlined" style="font-size:14px; vertical-align:middle">calendar_month</span> ${translations[currentLang].depart_date}: ${dateStr} 
                    | <span class="material-symbols-outlined" style="font-size:14px; vertical-align:middle">location_on</span> ${translations[currentLang].origin_station}: ${sID}
                </div>
            `;
            div.onclick = () => {
                panel.style.display = 'none';
                disambiguationData = null; // 清除数据
                fetchDetails(triple);
            };
            list.appendChild(div);
        });
        panel.style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function fetchDetails(triple) {
        currentTriple = triple;
        const [tNum, originID, ts] = triple.split('-');
        try {
            const res = await fetch(`${API_BASE}/andamentoTreno/${originID}/${tNum}/${ts}`);
            if (res.status === 204) {
                const msg = currentLang === 'zh' ? "该班次暂无实时数据（可能已过期或尚未生成）" :
                           currentLang === 'it' ? "Nessun dato in tempo reale per questo treno (potrebbe essere scaduto o non ancora generato)" :
                           "No real-time data for this train (may be expired or not yet generated)";
                return alert(msg);
            }
            const data = await res.json();
            currentTrainData = data;
            render(data);
        } catch (err) {
            const msg = currentLang === 'zh' ? "详情加载失败" :
                       currentLang === 'it' ? "Impossibile caricare i dettagli" :
                       "Failed to load details";
            alert(msg);
        }
    }

    // 刷新车次信息
    async function refreshTrainData() {
        if (!currentTriple) return;
        const refreshBtn = document.querySelector('.refresh-btn');
        if (refreshBtn) {
            refreshBtn.style.opacity = '0.5';
            refreshBtn.style.pointerEvents = 'none';
        }
        await fetchDetails(currentTriple);
        if (refreshBtn) {
            setTimeout(() => {
                refreshBtn.style.opacity = '1';
                refreshBtn.style.pointerEvents = 'auto';
            }, 1000);
        }
    }

    function formatT(ms) {
        if (!ms) return null;
        return new Date(ms).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', timeZone: 'Europe/Rome' });
    }

    function renderTimeHtml(label, schedMs, realMs, delayMin) {
        const sched = formatT(schedMs);
        const real = formatT(realMs);
        if (!real) return `<div class="time-item"><span class="time-label">${label} | ${translations[currentLang].expected}:</span> <b>${sched || '--:--'}</b></div>`;
        const isDiff = sched !== real;
        const colorClass = (delayMin > 0) ? "late" : "early";
        return `
            <div class="time-item">
                <span class="time-label">${label} |</span> 
                ${isDiff ? `<span class="time-val-sched">${sched}</span>` : ''}
                <span class="time-val-real ${colorClass}">${real}</span>
            </div>
        `;
    }

    function render(data) {
        document.getElementById('results').style.display = 'block';
        const card = document.getElementById('trainCard');
        const timeline = document.getElementById('timelineBody');

        // --- 核心逻辑：箭系列类型识别 ---
        let catCode = (data.categoria || "").trim();
        // 如果 categoria 为空，尝试从 compNumeroTreno (如 " FR 9505") 提取前缀
        if (!catCode && data.compNumeroTreno) {
            const match = data.compNumeroTreno.match(/([A-Z]+)/);
            if (match) catCode = match[1];
        }

        const operator = CLIENT_MAP[data.codiceCliente] || "Other";
        const category = CAT_MAP[catCode] || data.categoriaDescrizione || catCode || "Treno";
        
        // 获取运营商链接
        const operatorLink = CLIENT_LINK_MAP[operator] || "#";
        const operatorHTML = operatorLink !== "#" ? `<a href="${operatorLink}" target="_blank" style="color: inherit; text-decoration: none;">${operator}</a>` : operator;
        
        // 获取服务类型图片
        const imageKey = `${data.codiceCliente}-${catCode}`;
        const categoryImage = CAT_IMAGE_MAP[imageKey];
        const categoryHTML = categoryImage ? `<img src="${categoryImage}" alt="${category}" style="height: 1.3rem; vertical-align: middle; margin-left: 8px;">` : category;

        const displayOrigin = data.origineEstera || data.origine;
        const displayDest = data.destinazioneEstera || data.destinazione;
        const delayMsg = translateStatus(data.compRitardoAndamento[0]);
        const isEarly = delayMsg.includes(translations[currentLang].early_by) || 
                       delayMsg.includes(translations[currentLang].on_time) ||
                       delayMsg.toLowerCase().includes("anticipo") ||
                       delayMsg.toLowerCase().includes("orario") ||
                       delayMsg.toLowerCase().includes("early");

        const formattedDuration = formatDuration(data.compDurata);

        card.innerHTML = `
            <div class="refresh-btn" onclick="refreshTrainData()" title="${currentLang === 'zh' ? '刷新' : currentLang === 'it' ? 'Aggiorna' : 'Refresh'}">
                <span class="material-symbols-outlined">refresh</span>
            </div>
            <div class="op-cat-row" style="display: flex; align-items: center;">${operatorHTML} · ${categoryHTML}</div>
            <div class="train-info-wrapper">
                <div>
                    <div class="train-route">${displayOrigin} ➜ ${displayDest}</div>
                    <div class="train-meta">
                        ${translations[currentLang].train_num}: <b>${data.compNumeroTreno}</b> | ${translations[currentLang].duration}: <b>${formattedDuration}</b>
                    </div>
                </div>
                <div class="train-status-section">
                    <div class="train-delay ${isEarly ? '' : 'late'}">${delayMsg}</div>
                    <div class="train-last-position">${translations[currentLang].last_position}: ${data.stazioneUltimoRilevamento} (${data.compOraUltimoRilevamento || '--:--'})</div>
                </div>
            </div>
        `;

        // 渲染实时公告 (subTitle)
        if (data.subTitle && data.subTitle.trim()) {
            card.innerHTML += `
                <div class="alert-box">
                    <span class="material-symbols-outlined" style="font-size:20px">campaign</span>
                    <span>${data.subTitle}</span>
                </div>
            `;
        }

        // Timeline 进度算法 - Segment 分段式
        timeline.innerHTML = '';
        
        // 计算锚点索引：最后一个有实际到达或出发记录的站点
        let lastReachedIdx = -1;
        if (!data.nonPartito) {
            data.fermate.forEach((f, i) => { 
                if (f.arrivoReale !== null || f.partenzaReale !== null) lastReachedIdx = i; 
            });
        }

        const totalStations = data.fermate.length;

        data.fermate.forEach((f, i) => {
            const isLast = i === totalStations - 1;
            const isFirst = i === 0;
            
            // 状态机逻辑 - 确定圆点状态
            let dotClass = 'dot-future';  // 默认：未到达
            if (lastReachedIdx >= 0) {
                if (i < lastReachedIdx) {
                    dotClass = 'dot-passed';   // 已通过的站点（小绿点）
                } else if (i === lastReachedIdx) {
                    dotClass = 'dot-current';  // 当前站点（带动画的大绿点）
                }
            }
            
            // 状态机逻辑 - 确定轨道段状态
            // 规则：索引 i 与 i+1 之间的轨道，当 i < lastReachedIdx 时变绿
            const isSegmentActive = (i < lastReachedIdx);
            const segmentClass = isSegmentActive ? 'segment-line segment-active' : 'segment-line';
            
            const stationItemClasses = ['station-item', dotClass];

            const pPlat = f.binarioProgrammatoPartenzaDescrizione || f.binarioProgrammatoArrivoDescrizione;
            const ePlat = f.binarioEffettivoPartenzaDescrizione || f.binarioEffettivoArrivoDescrizione;
            let platHTML = (ePlat && pPlat && ePlat !== pPlat) 
                ? `<span class="plat-old">${pPlat}</span><span class="plat-new">${ePlat}</span>`
                : `<span class="plat-normal">${pPlat || "--"}</span>`;

            const stayMinutes = (f.partenza_teorica && f.arrivo_teorico) ? Math.round((f.partenza_teorica - f.arrivo_teorico) / 60000) : null;
            const stayTime = stayMinutes ? `${stayMinutes} ${translations[currentLang].minutes}` : "N/A";
            
            // 获取方向信息（如果有的话）- 显示在站名旁边
            let directionBadge = '';
            if (f.orientamento) {
                let directionText = '';
                if (f.orientamento === 'A') {
                    directionText = `Executive ${translations[currentLang].in_tail}`;
                } else if (f.orientamento === 'B') {
                    directionText = `Executive ${translations[currentLang].in_head}`;
                } else {
                    directionText = f.orientamento;
                }
                directionBadge = `<span class="direction-badge">${directionText}</span>`;
            }

            // 生成站点HTML - 包含圆点、轨道段和卡片
            const stationHTML = `
                <div class="${stationItemClasses.join(' ')}">
                    <div class="station-dot-wrapper">
                        <div class="station-dot"></div>
                        <div class="${segmentClass}"></div>
                    </div>
                    <div class="station-card">
                        <div class="station-name">
                            <span>${f.stazione}</span>
                            ${directionBadge}
                        </div>
                        <div class="info-row">
                            ${!isFirst ? renderTimeHtml(translations[currentLang].arrival, (f.arrivo_teorico || f.programmata), f.arrivoReale, f.ritardoArrivo) : ''}
                            ${!isLast ? renderTimeHtml(translations[currentLang].departure, (f.partenza_teorica || f.programmata), f.partenzaReale, f.ritardoPartenza) : ''}
                            ${(!isFirst && !isLast) ? `<div class="time-item"><span class="time-label">${translations[currentLang].stop_duration}:</span> <b>${stayTime}</b></div>` : ''}
                        </div>
                        <div class="info-row secondary">
                            <div class="time-item"><span class="time-label">${translations[currentLang].platform}:</span> ${platHTML}</div>
                            <div class="time-item" style="color: var(--text-grey);"><span class="time-label">Progressivo:</span> <b>${f.progressivo}</b></div>
                        </div>
                    </div>
                </div>
            `;
            timeline.innerHTML += stationHTML;
        });
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
</script>
</body>
</html>